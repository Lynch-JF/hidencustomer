<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GrÃ¡fica por Sacador</title>

  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; }
    .container-grafica {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
    }
    .container-grafica h2 { text-align: center; margin-bottom: 10px; }
    #conteo-pedidos {
      margin-bottom: 15px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="navbar-logo">
      <img src="LOGO-Photoroom.png" alt="Logo" />
      <span>Reporte de Pedidos</span>
    </div>
  </nav>

  <div class="container-grafica">
    <h2>ðŸ“Š Promedio por Sacador</h2>
    <div id="conteo-pedidos">Total de pedidos: 0</div>
    <canvas id="grafica-tiempo" width="900" height="350"></canvas>
  </div>

  <script>
    const API_SHEET = "https://api.sheetbest.com/sheets/8f3c4cce-1f76-488f-8402-9d6e21359ee1";
    let chartGrafica = null;

    async function cargarGrafica() {
      try {
        const res = await fetch(API_SHEET);
        const data = await res.json();

        const mapa = {};
        let totalPedidos = 0;

        data.forEach(row => {
          const nombre = String(row["Sacador"] || "").trim();
          const limpio = String(row["Grafica"] || "").trim();
          const num = parseFloat(limpio);

          if (!nombre || isNaN(num)) return;

          totalPedidos++;

          if (!mapa[nombre]) {
            mapa[nombre] = { total: 0, count: 0 };
          }

          mapa[nombre].total += num;
          mapa[nombre].count++;
        });

        document.getElementById("conteo-pedidos").textContent =
          `Total de pedidos: ${totalPedidos}`;

        const labels = [];
        const dataset = [];

        Object.entries(mapa).forEach(([nombre, info]) => {
          labels.push(`${nombre} (${info.count})`);
          dataset.push(info.total / info.count);
        });

        const ctx = document.getElementById("grafica-tiempo").getContext("2d");

        if (chartGrafica) {
          chartGrafica.data.labels = labels;
          chartGrafica.data.datasets[0].data = dataset;
          chartGrafica.update();
          return;
        }

        chartGrafica = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Promedio por Sacador",
              data: dataset,
              backgroundColor: "rgba(54,162,235,0.6)",
              borderColor: "rgba(54,162,235,1)",
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "Valor" } },
              x: { title: { display: true, text: "Sacador (Pedidos)" } }
            }
          }
        });

      } catch (e) {
        console.error("Error cargando grÃ¡fica:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarGrafica();
      setInterval(cargarGrafica, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
